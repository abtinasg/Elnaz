name: QA Tests CI/CD Pipeline

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # Job 1: Backend Unit & API Tests
  backend-tests:
    name: Backend Tests (Python/pytest)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install backend dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-flask pytest-cov

      - name: Initialize test database
        run: |
          cd backend
          python -c "from database import init_database; init_database()"

      - name: Run backend tests
        run: |
          cd tests/api
          pytest -v --cov=../../backend --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: backend
          name: backend-coverage

  # Job 2: Frontend E2E Tests (Playwright)
  frontend-e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Initialize database
        run: |
          cd backend
          python -c "from database import init_database; init_database()"

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Playwright
        run: |
          npm install -D @playwright/test
          npx playwright install --with-deps ${{ matrix.browser }}

      - name: Start Flask backend server
        run: |
          cd backend
          python app.py &
          echo "Waiting for server to start..."
          sleep 10
          curl -f http://localhost:5000/api/health || echo "Server not ready yet"
          sleep 5

      - name: Run Playwright tests on ${{ matrix.browser }}
        run: npx playwright test --project=${{ matrix.browser }}
        env:
          BASE_URL: http://localhost:5000

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}
          path: test-results/
          retention-days: 30

  # Job 3: Performance & SEO Testing (Lighthouse CI)
  lighthouse-tests:
    name: Performance & SEO (Lighthouse)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Initialize database
        run: |
          cd backend
          python -c "from database import init_database; init_database()"

      - name: Start Flask server
        run: |
          cd backend
          python app.py &
          sleep 10

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse CI
        run: lhci autorun --config=.lighthouserc.json
        continue-on-error: true

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 30

  # Job 4: Security Scan (OWASP ZAP Baseline)
  security-scan:
    name: Security Scan (OWASP ZAP)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Start Flask server
        run: |
          cd backend
          python app.py &
          sleep 10

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:5000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-report/
          retention-days: 30

  # Job 5: Test Report Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-e2e-tests, lighthouse-tests]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Create test summary
        run: |
          echo "# ğŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Tests: ${{ needs.backend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.frontend-e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse: ${{ needs.lighthouse-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Playwright reports uploaded for all browsers" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse performance report available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CI Pipeline completed!" >> $GITHUB_STEP_SUMMARY

  # Job 6: Notify on Failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-e2e-tests, lighthouse-tests, security-scan]
    if: failure()

    steps:
      - name: Send notification
        run: |
          echo "âš ï¸ Tests failed! Please check the logs."
          # Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ notification Ø¨Ù‡ Slack/Discord/Email Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯

# Optional: Schedule for nightly tests
# on:
#   schedule:
#     - cron: '0 2 * * *'  # Run at 2 AM UTC every day
